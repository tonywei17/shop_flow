# 开发日志 2026-01-03

## 概要
今天完成了权限管理系统的深度验证与调试，修复了登录逻辑中的一个关键 Bug，并优化了账号管理界面的 UI 体验。

## 完成的工作

### 1. 权限系统验证与调试
- **超级管理员验证**：通过本地调试确认超级管理员拥有完整权限，Sidebar 及路由保护（FeatureGuard）均按预期工作。
- **测试账号创建**：成功创建了支局（`test_shikyoku_01`）和教室（`test_classroom_01`）的测试账号。
- **修复登录 Bug**：
    - **问题**：原登录接口对所有账户都使用环境变量中的管理员密码校验，导致数据库账户无法登录。
    - **修复**：修改了 `apps/web/src/app/api/auth/login/route.ts`，使其根据账号 ID 自动路由校验逻辑（`admin` 使用环境密码，其余使用数据库 Bcrypt 哈希）。
- **数据隔离修复**：
    - **问题**：支局账号登录后能看到全量部署数据。
    - **修复**：发现手动创建的账号缺失 `role_id` 关联，导致权限降级为全权限。已通过 SQL 补全关联，成功激活了 `self_and_descendants` 数据隔离。

### 2. UI/UX 优化
- **弹窗布局修复**：
    - **问题**：账号编辑/新建弹窗在内容较长时，“保存”按钮会被挤出视口或遮挡。
    - **修复**：重构了 `ManagementDrawer.tsx`，将 `SheetFooter` 固定在底部，并使中间内容区域独立滚动。

## 待办事项
- [ ] 在 API 内部路由中引入更严格的功能权限校验（后端闭环）。
- [ ] 验证跨部门数据隔离在其他模块（如订单、商品）的表现。

## 状态
🟢 **已同步至最新设计标准**
