# 企业内部管理系统 PRD（产品需求文档）

> 技术栈基底：Next.js + Supabase + Stripe + Langflow（AI 引擎）
> 多客户复用：通过多租户与配置化/插件化实现按客户微调。

## 1. 背景与目标
- **背景**：面向拥有分部与加盟店网络的中大型企业，统一内部结算、组织管理、会员、网课、商城等业务，减少信息孤岛，提高效率与透明度。
- **目标**：
  - **模块化**：各模块高内聚、低耦合，可独立部署或禁用。
  - **可扩展**：支持多客户、多租户；按客户差异快速微调。
  - **可观测**：关键业务可审计、可追踪、可预警。
  - **智能化**：通过 Langflow 注入 AI 自动化能力，减少人工操作。

## 2. 使用者画像与角色
- **超级管理员（平台）**：跨租户运营、全局策略、套餐与计费。
- **企业管理员（租户）**：企业级参数、组织结构、权限、结算策略。
- **分部管理员**：分部资料、人员/门店、指标与对账。
- **门店/加盟店店长**：门店运营、订单、库存、对账。
- **员工**：日常业务操作、内容制作、课程运营。
- **会员/学员**：学习、购物、权益、售后。
- **讲师/内容方**：课程内容发布、收入分成、结算。

## 3. 业务范围与模块划分

### 3.1 企业内部结算系统
- **能力**：应收应付、结算周期、分润规则、成本中心、发票管理、账期、对账单、异常处理、审批流。
- **关键配置**：多币种、税率、发票抬头、开票规则、记账维度。
- **输出**：
  - 结算单/对账单 PDF 导出
  - 结算事件（供报表、AI 摘要、风控订阅）

### 3.2 分部与加盟店管理
- **组织结构**：集团-事业部-分部-门店层级，支持多维度授权。
- **门店/加盟店**：资料、合同、合规、KPI、巡检记录。
- **合同与分润**：多合同版本、分润方案归档与历史追溯。

### 3.3 会员管理（CRM）
- **档案**：基础资料、实名认证、标签、偏好。
- **等级与权益**：成长值、等级折扣、付费会员、有效期。
- **资产**：积分、余额、优惠券、储值卡、发票抬头。
- **运营**：触达（站内信/邮件/短信）、活动、裂变。

### 3.4 内部网课平台（LMS）
- **课程**：专栏/单课/系列课，章节与资源管理（视频、PDF、题库）。
- **学习**：进度、考试、证书、作业、互动（评论/Q&A）。
- **内容安全**：DRM、试看、访问控制。
- **讲师结算**：课程分成、课时统计、分润归集到结算系统。
- **AI 助教**：知识库问答、章节摘要、个性化学习建议。

### 3.5 内部商城（B2B/B2E）
- **商品**：SPU/SKU、价格策略、库存、上下架、分类、规格。
- **订单**：下单、支付、发票、配送/自提、售后（退换/退款）。
- **促销**：满减、满赠、组合包、限时折扣、优惠券。
- **结算联动**：订单毛利、分润入账、门店/讲师/供应商结算。

### 3.6 通用模块
- **用户与权限**：SSO、RBAC/ABAC、组织与角色、细粒度资源许可。
- **审批流**：可视化流程、条件网关、抄送/加签、版本化。
- **通知中心**：站内信、邮件、短信、Webhook；统一模板与变量。
- **仪表盘与报表**：核心 KPI、分部看板、导出（CSV/Excel/PDF）。
- **审计与合规**：数据访问与操作审计、保留策略、可追溯。

### 3.7 AI 自动化引擎（Langflow）
- **应用场景**：
  - 工单自动分类/指派/生成回复草稿
  - 报表与对账单的自然语言摘要
  - 合同条款分析与风险提示
  - 课程内容提纲与测验自动生成
  - 商城客服问答、智能推荐
- **集成方式**：统一 AI 网关（API），Flow 模板版本化与灰度发布。

## 4. 非功能需求
- **性能**：
  - P95 API < 300ms（缓存命中场景）；关键报表 < 5s。
  - 单租户 10k DAU 可横向扩展，读写分离/缓存。
- **安全**：RLS 行级权限、最小权限、OAuth/SSO、Webhook 签名校验。
- **可用性**：99.9% 月度可用性，关键流程（下单、支付、结算）双活设计。
- **合规**：GDPR/CCPA（数据导出与删除）、发票与税务合规、日志审计。
- **可观测**：全链路日志、指标、追踪；告警与回溯。

## 5. 验收标准（核心流程）
- **下单-支付-结算打通**：产生订单 → Stripe 支付成功 → 订单完成 → 结算事件入库 → 结算单生成。
- **LMS 学习闭环**：学员购买课程 → 开通权限 → 学习记录/考试 → 证书发放 → 分润入账。
- **多租户隔离**：不同企业数据通过 RLS 强隔离，越权访问拦截。
- **AI 能力可灰度**：按租户/用户开关 AI 能力，回退不影响主流程。

## 6. 里程碑拆解（建议）
1. **基座与鉴权**：多租户、RBAC、菜单路由、审计、基础 UI。
2. **商城闭环 MVP**：商品/订单/支付（Stripe）+ 简单结算联动。
3. **LMS MVP**：课程与学习、讲师侧分润入账。
4. **结算系统增强**：分润与账期、多币种、发票、审批流。
5. **CRM 增强**：会员等级/权益、积分/余额、营销活动。
6. **Langflow AI 能力**：客服问答、报表摘要、工单自动化。
7. **报表与可观测性**：跨模块 KPI、告警、审计完善。

## 7. 风险与假设
- **假设**：
  - 大多数租户接受公有云 Supabase + 托管 Langflow/自建 Langflow。
  - Stripe 可覆盖主要支付场景（部分地区需补充支付渠道）。
- **风险**：
  - 多租户数据隔离复杂度高 → 强依赖 RLS 设计与测试。
  - 结算规则灵活多变 → 需要可配置规则引擎与回放能力。
  - AI 误判引发体验问题 → 全链路可回退与人工兜底机制。

## 8. 可配置与微调策略（面向多客户）
- **Feature Flags**：按租户/用户/角色启停功能。
- **参数化**：货币/税率/审批流/分润方案/课程模板/订单策略。
- **插件化**：模块可插拔（如替换支付、替换短信供应商）。
- **主题与品牌**：可换色、Logo、文案、导航；对外页面支持白标。

## 9. 成功指标（KPI）
- 实施周期缩短（从 X 月到 Y 周）。
- 运营人效提升（关键流程自动化率≥Z%）。
- 结算准确率≥99.9%，对账异常快速定位（≤N 分钟）。
- 学员完成率/复购率、会员活跃度等核心指标提升。
