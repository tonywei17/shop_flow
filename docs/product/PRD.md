# 企业内部管理系统 PRD（产品需求文档）

> 技术栈基底：Next.js + Supabase + Stripe + Langflow（AI 引擎）
> 多客户复用：通过多租户与配置化/插件化实现按客户微调。

## 1. 背景与目标
- **背景**：面向拥有分部与加盟店网络的中大型企业，统一内部结算、组织管理、会员、网课、商城等业务，减少信息孤岛，提高效率与透明度。
- **目标**：
  - **模块化**：各模块高内聚、低耦合，可独立部署或禁用。
  - **可扩展**：支持多客户、多租户；按客户差异快速微调。
  - **可观测**：关键业务可审计、可追踪、可预警。
  - **智能化**：通过 Langflow 注入 AI 自动化能力，减少人工操作。

## 2. 使用者画像与角色
- **超级管理员（平台）**：跨租户运营、全局策略、套餐与计费。
- **企业管理员（租户）**：企业级参数、组织结构、权限、结算策略。
- **分部管理员**：分部资料、人员/门店、指标与对账。
- **门店/加盟店店长**：门店运营、订单、库存、对账。
- **员工**：日常业务操作、内容制作、课程运营。
- **会员/学员**：学习、购物、权益、售后。
- **讲师/内容方**：课程内容发布、收入分成、结算。

## 3. 业务范围与模块划分

### 3.0 当前系统架构（2025-11 更新）

- **Monorepo 与工具链**：根目录采用 Turborepo + pnpm（`package.json`、`turbo.json`），将多套 Next.js 前端与领域包组织在同一个代码库中，便于共享类型、CI 统一与分模块发布。
- **前端应用层**：
  - `apps/web`：Next.js App Router 16 + React 19，承载后台 Dashboard。`src/app/(dashboard)` 下按业务域（会员、结算、课程等）拆分 Route Segment，`layout.tsx` 统一注入侧边栏与主题。后台 API 通过同目录下的 `app/api/*` Route Handler 暴露。
  - `apps/learning`：独立的日文线上学习前台，为 LMS 学员提供课程/考试体验，复用 Tailwind 4 Beta 样式体系。
  - `apps/storefront`：B2B/B2E 商品展示站点，直接依赖 `@enterprise/db` 读取 Supabase 中的商品数据并渲染产品卡片（`src/app/page.tsx`）。
- **BFF / API 层**：Dashboard 侧的写操作通过 Next Route Handlers 实现，例如 `apps/web/src/app/api/internal/products/route.ts` 负责商品列表与创建、统一处理租户参数与输入校验，再调用共享领域包。
- **共享领域包**（`packages/*`）：
  - `db`：封装 Supabase Admin 客户端与仓储方法（如 `src/products.ts` 提供 list/create/update/adjustStock）。
  - `domain-*`：按业务域（commerce/crm/lms/org/settlement 等）沉淀领域模型与对外接口，`domain-commerce` 内还封装了 Medusa Admin API 客户端。
  - `ai`、`auth`、`config`、`events`、`reports`、`stripe`、`types`：分别承载 Langflow 调用、鉴权工具、环境与 Feature Flag 解析、事件总线、报表导出、Stripe/支付以及全局类型定义。
- **外部服务与数据层**：
  - **Supabase**：作为主数据库/Auth/Storage，`packages/db/src/client.ts` 通过服务密钥创建无状态客户端，`supabase/` 目录预留迁移与策略。
  - **Stripe**：通过 `packages/stripe` 适配支付/发票流程，Webhook 入口位于 `apps/web/src/app/api/webhooks/stripe`（待实现/扩展）。
  - **Langflow**：AI 能力通过 `packages/ai` 统一封装（当前为占位实现），后续由 `/api/ai/*` 网关暴露。
  - **Medusa**：`medusa/` 目录包含独立的 Headless Commerce 服务，配合 `packages/domain-commerce` 进行商品同步与订单检索。
- **跨模块数据流示例**：后台创建商品 → `apps/web` 表单调用 `/api/internal/products` → `@enterprise/db` 写入 Supabase → `apps/storefront` 通过 `listProducts` 读取同一张表实现前台展示；同理，可将 Medusa SKU 通过 domain 包同步到 Supabase，再由结算/库存模块消费。

### 3.1 企业内部结算系统
- **能力**：应收应付、结算周期、分润规则、成本中心、发票管理、账期、对账单、异常处理、审批流。
- **关键配置**：多币种、税率、发票抬头、开票规则、记账维度。
- **输出**：
  - 结算单/对账单 PDF 导出
  - 结算事件（供报表、AI 摘要、风控订阅）

### 3.2 分部与加盟店管理
- **组织结构**：集团-事业部-分部-门店层级，支持多维度授权。
- **门店/加盟店**：资料、合同、合规、KPI、巡检记录。
- **合同与分润**：多合同版本、分润方案归档与历史追溯。

### 3.3 会员管理（CRM）
- **档案**：基础资料、实名认证、标签、偏好。
- **等级与权益**：成长值、等级折扣、付费会员、有效期。
- **资产**：积分、余额、优惠券、储值卡、发票抬头。
- **运营**：触达（站内信/邮件/短信）、活动、裂变。

### 3.4 内部网课平台（LMS）
- **课程**：专栏/单课/系列课，章节与资源管理（视频、PDF、题库）。
- **学习**：进度、考试、证书、作业、互动（评论/Q&A）。
- **内容安全**：DRM、试看、访问控制。
- **讲师结算**：课程分成、课时统计、分润归集到结算系统。
- **AI 助教**：知识库问答、章节摘要、个性化学习建议。

### 3.5 内部商城（B2B/B2E）
- **商品**：SPU/SKU、价格策略、库存、上下架、分类、规格。
- **订单**：下单、支付、发票、配送/自提、售后（退换/退款）。
- **促销**：满减、满赠、组合包、限时折扣、优惠券。
- **结算联动**：订单毛利、分润入账、门店/讲师/供应商结算。

### 3.6 通用模块
- **用户与权限**：SSO、RBAC/ABAC、组织与角色、细粒度资源许可。
- **审批流**：可视化流程、条件网关、抄送/加签、版本化。
- **通知中心**：站内信、邮件、短信、Webhook；统一模板与变量。
- **仪表盘与报表**：核心 KPI、分部看板、导出（CSV/Excel/PDF）。
- **审计与合规**：数据访问与操作审计、保留策略、可追溯。

### 3.7 AI 自动化引擎（Langflow）
- **应用场景**：
  - 工单自动分类/指派/生成回复草稿
  - 报表与对账单的自然语言摘要
  - 合同条款分析与风险提示
  - 课程内容提纲与测验自动生成
  - 商城客服问答、智能推荐
- **集成方式**：统一 AI 网关（API），Flow 模板版本化与灰度发布。

### 3.8 前端 AI 助手（右下角聊天浮窗）

- **目标**：在用户操作业务页面时，提供实时的 AI 问答/说明能力，减少培训与反复沟通成本，提升复杂业务场景下的自助解答率。
- **与 3.7 关系**：3.7 定义的是底层 Langflow AI 引擎与网关；3.8 是面向终端用户的可见入口（UI + 交互），通过应用后端安全地调用 3.7 所述能力。

#### 3.8.1 使用场景与角色

- **后台运营/管理员**：在查看订单、结算、学习分析等复杂页面时，询问「这个字段代表什么？」「这张结算单为什么是这个金额？」
- **学習プラットフォーム学员**：在前台课程/考试/支付页面，询问「考试规则是什么？」「为什么这笔考试费没有入账？」（视具体租户是否开启学员侧入口）。

典型问题示例：

- 「帮我解释一下这张学習PF订单的状态和支付情况。」
- 「最近 3 个月考试费的总额是多少？按月份拆开。」
- 「会员费和活动参加费在系统里的差异是什么？」

#### 3.8.2 交互与体验设计

- **入口位置**：
  - Web 端右下角悬浮按钮（圆形/带图标），全局挂载在后台 `Dashboard Layout`，可按模块/租户开关。
  - 按租户配置是否在学習プラットフォーム前台也显示同样入口。
- **打开方式**：
  - 用户点击悬浮按钮 → 右下角弹出聊天浮窗（可拖动或固定）。
  - 再次点击或点击关闭图标 → 折叠回仅图标状态。
- **聊天浮窗基础元素**：
  - 顶部：标题（如「AI アシスタント」）、当前环境提示（如「学習PF注文詳細」）、关闭按钮。
  - 中部：对话区，显示时间顺序的消息气泡（区分用户/AI），支持滚动。
  - 底部：输入框 + 发送按钮，支持回车发送；可预留「常见问题快捷按钮」。
  - 文案说明：底部一行提示「AI 回答仅供参考，最终以系统实际数据为准」。

#### 3.8.3 技术架构与数据流

- **总体架构**：
  - 浏览器前端 → 应用后端 AI Gateway → Langflow Agent 服务器 → 应用后端 → 浏览器前端。
- **前端（Next.js）**：
  - 仅负责 UI 展示与收集用户输入。
  - 每次发送消息时，调用自有后端 `/api/ai/chat` 接口，并附带轻量的页面上下文（如 `pageType`, `resourceId`）。
- **应用后端（AI Gateway）**：
  - 是唯一能同时访问业务数据和 Langflow 的组件。
  - 责任：
    - 通过 Session/JWT/Supabase Auth 等方式识别用户，并根据租户/角色/组织做权限校验。
    - 根据 `pageType + resourceId` 获取当前页面相关数据（如当前订单、考试、会员信息）。
    - 仅在用户有权限的前提下，组合成简明的上下文（摘要 + 关键字段），作为 Langflow 的输入之一。
    - 调用 Langflow 提供的 HTTP API，并将回答返回前端。
- **Langflow Agent 服务器**：
  - 部署在独立环境，仅对应用后端开放（IP 白名单 / API Key 保护）。
  - 不直接持有数据库连接或用户 Token，所有业务数据均由应用后端整理后传入。
  - Langflow Flow 可通过「工具调用」模式访问应用后端暴露的少量受控 API（例如 `GET /ai-tools/orders/:id/summary`），由后端继续负责权限与脱敏。

#### 3.8.4 权限与数据范围控制

- 权限判断与数据过滤全部在应用后端完成：
  - Langflow 不直接访问数据库，不负责权限判断，只基于调用方提供的数据与工具结果生成回答。
  - 应用后端根据用户身份和角色决定：
    - 当前页面是否允许暴露给 AI；
    - 可用于回答的问题的数据范围与字段级脱敏策略。
- 数据最小化：
  - 不一次性把用户所有可访问数据全量传给 Langflow，而是按问题与工具调用按需查询。
  - 对敏感字段（如身份证号、完整地址、银行卡号等）统一做掩码或完全不暴露。

#### 3.8.5 迭代路线（里程碑级别）

1. **V0：说明型 AI 助手（不查业务数据）**
   - 正式上线前的最小版本，仅基于系统文档/帮助中心回答「如何使用系统」「字段含义」类问题。
   - 不访问业务数据库，主要用于打通前端 → 后端 → Langflow 全链路与体验验证。
2. **V1：当前页面上下文 + 只读查询**
   - 从少数关键页面试点（例如学習PF 订单详情、考试新建页面）。
   - AI 可以看到当前页面对象（订单/考试等）的只读摘要，回答解释类问题，但不能发起任何写操作。
3. **V2：有限的跨资源检索能力**
   - 增加受控工具 API，例如「查询某学员最近 N 笔考试支付记录」「按月份统计考试费」。
   - 严格限制每次会话可查询的资源范围与数量，并在回答中附带引用（如订单号、时间范围）。
4. **V3（可选）：写操作辅助（草稿级）**
   - 仅生成审批意见、通知文案、说明文字等草稿，由人工确认后再提交，不直接落库。
   - 默认不开启，按租户/角色精细化配置。

#### 3.8.6 验收要点

- 前端：
  - 在指定的后台页面右下角可看到 AI 悬浮按钮，点击后弹出聊天窗，交互顺畅，视觉风格与现有 UI 一致。
  - 聊天窗顶部能清晰显示当前上下文信息（例如「学習PF注文詳細」）。
- 后端与安全：
  - `/api/ai/chat` 接口仅在用户已登录且有权限的前提下可用。
  - 在日志中能追踪每次 AI 调用对应的用户、租户、页面与数据来源，便于审计。
- AI 体验：
  - 对于已接入的试点页面，AI 能正确引用当前页面数据进行解释，且在权限受限时会明确说明无法访问相关信息，而不是臆造。

## 4. 非功能需求
- **性能**：
  - P95 API < 300ms（缓存命中场景）；关键报表 < 5s。
  - 单租户 10k DAU 可横向扩展，读写分离/缓存。
- **安全**：RLS 行级权限、最小权限、OAuth/SSO、Webhook 签名校验。
- **可用性**：99.9% 月度可用性，关键流程（下单、支付、结算）双活设计。
- **合规**：GDPR/CCPA（数据导出与删除）、发票与税务合规、日志审计。
- **可观测**：全链路日志、指标、追踪；告警与回溯。

## 5. 验收标准（核心流程）
- **下单-支付-结算打通**：产生订单 → Stripe 支付成功 → 订单完成 → 结算事件入库 → 结算单生成。
- **LMS 学习闭环**：学员购买课程 → 开通权限 → 学习记录/考试 → 证书发放 → 分润入账。
- **多租户隔离**：不同企业数据通过 RLS 强隔离，越权访问拦截。
- **AI 能力可灰度**：按租户/用户开关 AI 能力，回退不影响主流程。

## 6. 里程碑拆解（建议）
1. **基座与鉴权**：多租户、RBAC、菜单路由、审计、基础 UI。
2. **商城闭环 MVP**：商品/订单/支付（Stripe）+ 简单结算联动。
3. **LMS MVP**：课程与学习、讲师侧分润入账。
4. **结算系统增强**：分润与账期、多币种、发票、审批流。
5. **CRM 增强**：会员等级/权益、积分/余额、营销活动。
6. **Langflow AI 能力**：客服问答、报表摘要、工单自动化。
7. **报表与可观测性**：跨模块 KPI、告警、审计完善。

## 7. 风险与假设
- **假设**：
  - 大多数租户接受公有云 Supabase + 托管 Langflow/自建 Langflow。
  - Stripe 可覆盖主要支付场景（部分地区需补充支付渠道）。
- **风险**：
  - 多租户数据隔离复杂度高 → 强依赖 RLS 设计与测试。
  - 结算规则灵活多变 → 需要可配置规则引擎与回放能力。
  - AI 误判引发体验问题 → 全链路可回退与人工兜底机制。

## 8. 可配置与微调策略（面向多客户）
- **Feature Flags**：按租户/用户/角色启停功能。
- **参数化**：货币/税率/审批流/分润方案/课程模板/订单策略。
- **插件化**：模块可插拔（如替换支付、替换短信供应商）。
- **主题与品牌**：可换色、Logo、文案、导航；对外页面支持白标。

## 9. 成功指标（KPI）
- 实施周期缩短（从 X 月到 Y 周）。
- 运营人效提升（关键流程自动化率≥Z%）。
- 结算准确率≥99.9%，对账异常快速定位（≤N 分钟）。
- 学员完成率/复购率、会员活跃度等核心指标提升。

## 10. 开发里程碑与变更记录

### 2025-12-04 里程碑：shadcn/ui 组件库正式导入

- **UI 组件标准化**：
  - 正式导入 shadcn/ui 组件库到 `apps/web`，使用 new-york 风格
  - 通过官方 CLI 安装 27+ 个标准组件（button, dialog, select, form, table 等）
  - 配置 `components.json` 统一管理组件安装与更新
  - 创建 `@/lib/utils` 工具函数（cn 函数用于 className 合并）

- **Select 组件修复**：
  - 解决 Dialog 内 Select 下拉菜单被遮挡的 z-index 问题
  - 修复下拉菜单选项缺少内边距的样式问题
  - 统一 hover/focus 状态的视觉效果

- **开发体验提升**：
  - 今后添加新组件只需运行 `pnpm dlx shadcn@latest add [组件名]`
  - 组件样式与官方 shadcn/ui 完全一致，减少手动调整
  - tsconfig 路径别名确保 apps/web 组件优先于共享组件

### 2025-12-03 里程碑：角色权限系统与功能级访问控制

- **功能权限（feature_permissions）**：
  - 数据库 `roles` 表新增 `feature_permissions text[]` 字段
  - 角色编辑 UI 支持功能权限树的选择与保存
  - 支持按功能模块（nav href）进行细粒度权限控制

- **侧边栏权限过滤**：
  - Sidebar 组件支持 `allowedFeatureIds` 属性
  - 根据当前用户角色动态显示/隐藏菜单项
  - 实现白名单型的菜单权限控制

- **路由级访问控制（FeatureGuard）**：
  - 新增 `FeatureGuard` 组件包裹 Dashboard 子页面
  - 无权限时显示 403 提示，阻止页面内容渲染
  - 支持 URL 路径到功能 ID 的自动解析

- **超级管理员**：
  - `admin` 账号或匹配 `ADMIN_LOGIN_ID` 的账号自动获得全部权限
  - 跳过菜单过滤与路由守卫

### 2025-11-20 里程碑：后台 Sidebar 改造 & Supabase 迁移

- **UI 改造**：
  - 后台 Dashboard 左侧 Sidebar 按 Figma 设计重构，统一导航结构与视觉风格。
  - Sidebar 支持内部菜单区域垂直滚动，底部 CTA 区域固定，新增「学習プラットフォームへ」「オンラインストアへ」按钮。
  - 替换管理端 Logo 为 `/apps/web/public/eu_logo.png` 资源。
- **Supabase 迁移**：
  - 将本地/项目 Supabase 配置整体迁移至自建实例 `https://supabase.nexus-tech.cloud`。
  - 更新根目录与 apps 层 `.env.local` 中的 `SUPABASE_URL`、`SUPABASE_ANON_KEY`、`SUPABASE_SERVICE_ROLE_KEY`，以及 `apps/storefront/.env.local` 中的 `NEXT_PUBLIC_SUPABASE_*`。
  - 新建《MY_SUPABASE_COMPLETE_GUIDE.md》文档，统一记录自建 Supabase 的连接信息与 MCP 使用指南。
- **MCP 集成**：
  - 在 Windsurf 中配置 Supabase MCP（Docker 镜像 `mcp/supabase`），通过 `SUPABASE_URL` + `SUPABASE_SERVICE_KEY` 完成连接。
  - 已通过 MCP 进行基础读写验证（认证通过，能访问自建实例中的表）。
- **下一步计划**：
  - 基于 Supabase 设计并落地账号体系（角色/部门/账号），通过 MCP 批量初始化基础数据。
  - 将后台、学习平台与商城的登录与权限模型逐步对齐到统一账号体系。
