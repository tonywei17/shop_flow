# DEVLOG - 2025-12-05

## 今日の開発トピック

- ロールのデータ権限範囲（data_scope_type）機能の完全実装
- データベース関数の作成（部署階層クエリ）
- アプリケーション層でのデータフィルタリングロジック実装
- 機能権限の表示改善（分組別表示）

---

## 1. ロールのデータ権限範囲（Data Scope）機能

### 1-1. データベーススキーマ変更

`roles` テーブルに以下のカラムを追加：

```sql
ALTER TABLE public.roles
ADD COLUMN data_scope_type text NOT NULL DEFAULT 'all';

ALTER TABLE public.roles
ADD COLUMN allowed_department_ids uuid[] DEFAULT '{}';
```

| カラム | 型 | 説明 |
|--------|------|------|
| `data_scope_type` | text | `all`, `self_and_descendants`, `self_only`, `custom` のいずれか |
| `allowed_department_ids` | uuid[] | `custom` モード時のアクセス可能部署IDリスト |

### 1-2. データベース関数の作成

#### get_department_descendants(dept_id uuid)
指定部署とその全下位部署のIDを再帰的に取得する関数。

```sql
CREATE OR REPLACE FUNCTION get_department_descendants(dept_id uuid)
RETURNS TABLE(id uuid) AS $$
WITH RECURSIVE dept_tree AS (
  SELECT d.id FROM departments d WHERE d.id = dept_id
  UNION ALL
  SELECT d.id FROM departments d
  INNER JOIN dept_tree dt ON d.parent_id = dt.id
)
SELECT id FROM dept_tree;
$$ LANGUAGE sql STABLE;
```

#### get_user_accessible_departments(user_dept_id uuid, user_role_id uuid)
ユーザーの所属部署とロールに基づき、アクセス可能な部署IDリストを返す関数。

```sql
CREATE OR REPLACE FUNCTION get_user_accessible_departments(user_dept_id uuid, user_role_id uuid)
RETURNS TABLE(department_id uuid) AS $$
DECLARE
  scope_type text;
  custom_dept_ids uuid[];
BEGIN
  SELECT r.data_scope_type, r.allowed_department_ids
  INTO scope_type, custom_dept_ids
  FROM roles r WHERE r.id = user_role_id;

  IF scope_type = 'all' THEN
    RETURN QUERY SELECT d.id FROM departments d;
  ELSIF scope_type = 'self_and_descendants' THEN
    RETURN QUERY SELECT * FROM get_department_descendants(user_dept_id);
  ELSIF scope_type = 'self_only' THEN
    RETURN QUERY SELECT user_dept_id;
  ELSIF scope_type = 'custom' THEN
    RETURN QUERY SELECT unnest(custom_dept_ids);
  END IF;
END;
$$ LANGUAGE plpgsql STABLE;
```

### 1-3. packages/db の更新

#### 新規ファイル: `packages/db/src/data-scope.ts`

データ権限フィルタリングのコアロジックを実装：

- `getAccessibleDepartmentIds(context)` - ユーザーがアクセス可能な部署IDリストを取得
- `canAccessDepartment(context, targetDeptId)` - 特定部署へのアクセス権限チェック
- `applyDataScopeFilter(context)` - クエリに適用するフィルタ情報を返す
- `getDataScopeFromRole(roleId)` - ロールからデータ権限設定を取得
- `getDataScopeContextForUser(userId)` - ユーザーの完全なデータ権限コンテキストを取得

#### 既存ファイルの更新

- `packages/db/src/roles.ts`
  - `RoleRecord` に `data_scope_type` と `allowed_department_ids` を追加
  - `CreateRoleInput` / `UpdateRoleInput` に同フィールドを追加
  - `listRoles` で新フィールドを取得・正規化
  - `inferDataScopeType()` ヘルパー関数で旧データとの互換性を確保

- `packages/db/src/departments.ts`
  - `ListDepartmentsParams` に `dataScopeContext` パラメータを追加
  - クエリ実行時にデータ権限フィルタを適用

- `packages/db/src/accounts.ts`
  - `ListAdminAccountsParams` に `dataScopeContext` パラメータを追加
  - クエリ実行時にデータ権限フィルタを適用

- `packages/db/src/index.ts`
  - 新規エクスポートを追加

### 1-4. apps/web の更新

#### 新規ファイル: `apps/web/src/lib/auth/data-scope-context.ts`

ユーザーのデータ権限コンテキストを取得するヘルパー：

- `getCurrentUser()` - 現在のユーザー情報を取得（TODO: 実際の認証システムと連携）
- `getCurrentUserDataScopeContext()` - 現在のユーザーのデータ権限コンテキストを取得
- `createDataScopeContext()` - テスト用にデータ権限コンテキストを手動作成

#### サービス層の更新: `apps/web/src/lib/services/org.ts`

- `getDepartmentsWithScope()` - データ権限付きで部署リストを取得
- `getAdminAccountsWithScope()` - データ権限付きでアカウントリストを取得

---

## 2. ロール編集UIの改善

### 2-1. データ範囲セレクター

- 対象: `apps/web/src/app/(dashboard)/roles/roles-client.tsx`
- RadioGroup を使用した4種類のデータ範囲選択UI：
  - すべてのデータ (`all`)
  - 所属部署と下位部署 (`self_and_descendants`)
  - 所属部署のみ (`self_only`)
  - カスタム (`custom`)
- カスタム選択時は `DepartmentMultiSelect` コンポーネントで部署を複数選択可能

### 2-2. 機能権限の表示改善

#### 変更前
- データ範囲に基づいた固定テキスト（「全機能アクセス」「部署+下位アクセス」など）

#### 変更後
- `feature_permissions` 配列を分析し、分組別に表示：
  - 全機能勾選 → 「全機能アクセス」
  - 特定分組の全機能勾選 → 分組名（例：「請求書関連」）
  - 特定分組の一部機能勾選 → 「分組名（一部）」（例：「オンラインストア管理（一部）」）
  - 権限なし → 「権限なし」
  - `null`/`undefined` → 「全機能アクセス」（後方互換性）

```typescript
function formatFeaturePermissions(featurePermissions: string[] | null | undefined): string[] {
  // null/undefined は全権限として扱う（後方互換性）
  if (featurePermissions === null || featurePermissions === undefined) {
    return ["全機能アクセス"];
  }
  
  // 空配列は明示的に権限なし
  if (featurePermissions.length === 0) {
    return ["権限なし"];
  }

  // 分組別に分析して表示
  // ...
}
```

---

## 3. ドキュメント更新

### 新規ドキュメント: `docs/architecture/DATA-SCOPE-IMPLEMENTATION.md`

データ権限範囲機能の実装備忘録：
- データ権限タイプの定義
- データベーススキーマ
- データベース関数
- アプリケーション層の使用方法
- 新規業務テーブル作成時の規範
- テスト検証方法

---

## 4. 変更ファイル一覧

### 新規作成
- `packages/db/src/data-scope.ts`
- `apps/web/src/lib/auth/data-scope-context.ts`
- `docs/architecture/DATA-SCOPE-IMPLEMENTATION.md`
- `docs/devlogs/DEVLOG-2025-12-05.md`

### 更新
- `packages/db/src/roles.ts`
- `packages/db/src/departments.ts`
- `packages/db/src/accounts.ts`
- `packages/db/src/index.ts`
- `apps/web/src/app/(dashboard)/roles/roles-client.tsx`
- `apps/web/src/lib/services/org.ts`

---

## 5. 今後の TODO

1. **認証システム連携**: `getCurrentUser()` を実際の認証システム（Supabase Auth など）と連携
2. **業務テーブル作成時**: 新規業務テーブルには `department_id` カラムを追加し、データ権限フィルタを適用
3. **RLS ポリシー**: 必要に応じて Row Level Security ポリシーを設定
4. **API ルート保護**: `/api/internal/...` ルートにもデータ権限チェックを追加
