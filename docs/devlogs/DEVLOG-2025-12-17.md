# Dev Log — 2025-12-17

## Summary
- Upgraded all Next.js apps (web/learning/storefront) to 16.0.10 to mitigate the latest security issue; aligned eslint-config-next/next-themes as needed.
- Reinstalled deps with pnpm; rebuilt web and learning successfully.
- Cleared ports 3000–3002 and restarted dev servers; storefront was initially unreachable because its dev process was not running, fixed by starting `pnpm --filter storefront dev`.
- **Comprehensive security hardening and feature improvements** (see below).

---

## Security Hardening & Feature Improvements

### 1. Login Security (High Priority) ✅
- **bcrypt password hashing**: Added `hashPassword`/`verifyPassword` in `@enterprise/auth`
- **Failed login tracking**: 5 failed attempts → 15-minute account lockout
- **HMAC-signed sessions**: Replaced simple token with Web Crypto API HMAC signatures
- **Secure cookies**: HttpOnly, SameSite=lax, Secure in production

**Files changed:**
- `packages/auth/src/password.ts` - bcrypt utilities
- `packages/auth/src/session.ts` - HMAC signing with Web Crypto API
- `apps/web/src/app/api/auth/login/route.ts` - Login with lockout logic
- `apps/web/src/middleware.ts` - Async session verification
- `apps/storefront/src/middleware.ts` - Async session verification

### 2. Order & Inventory (High Priority) ✅
- **Transactional order creation**: Single RPC call creates order + items + stock adjustment
- **Stock deduction**: Automatic inventory adjustment on order creation
- **Order cancellation**: Restores stock when order is cancelled
- **Order status flow**: pending → paid → processing → shipped → delivered

**New files:**
- `supabase/migrations/20251217_order_transaction_function.sql`
- `supabase/migrations/20251217_cancel_order_function.sql`
- `apps/storefront/src/app/api/orders/[id]/route.ts`
- `apps/storefront/src/app/account/orders/[id]/page.tsx`
- `apps/storefront/src/app/account/orders/[id]/cancel-order-button.tsx`
- `apps/web/src/app/api/internal/orders/route.ts`
- `apps/web/src/app/api/internal/orders/[id]/route.ts`
- `apps/web/src/app/(dashboard)/commerce/orders/[id]/page.tsx`
- `apps/web/src/app/(dashboard)/commerce/orders/[id]/order-detail-client.tsx`

### 3. Inventory Management (Medium Priority) ✅
- **Stock adjustment UI**: Added +/- buttons with dialog in inventory page
- **Adjustment API**: `/api/internal/inventory/adjust`
- **Adjustment reasons**: purchase, return, damage, correction, other

**Files changed:**
- `apps/web/src/app/(dashboard)/inventory/inventory-client.tsx`
- `apps/web/src/app/api/internal/inventory/adjust/route.ts` (new)

### 4. Address Book (Medium Priority) ✅
- **Input validation**: Postal code format (`\d{3}-?\d{4}`), phone validation
- **Edit functionality**: New edit page at `/account/addresses/[id]/edit`
- **Default address**: Set default with automatic clearing of other defaults

**Files changed:**
- `apps/storefront/src/app/account/addresses/page.tsx`
- `apps/storefront/src/app/account/addresses/[id]/edit/page.tsx` (new)

### 5. Audit & Monitoring (Medium Priority) ✅
- **Audit log table**: `audit_logs` with indexes for common queries
- **Audit utilities**: `createAuditLog`, `listAuditLogs` in `@enterprise/db`
- **Login auditing**: Success, failed, and locked events logged

**New files:**
- `supabase/migrations/20251217_audit_logs_table.sql`
- `packages/db/src/audit-log.ts`

### 6. Environment Configuration (High Priority) ✅
- **Security check**: Verified SERVICE_ROLE_KEY is server-side only
- **Updated `.env.example`**: Added security warnings and best practices

---

## Changes (Morning Session)
- `apps/web/package.json`: next/eslint-config-next → 16.0.10.
- `apps/learning/package.json`: next/eslint-config-next → 16.0.10.
- `apps/storefront/package.json`: next → 16.0.10, next-themes aligned to ^0.4.6.
- Dependency reinstall via `pnpm install`.

## Verification
- `pnpm --filter web build` (Turbopack) — pass; middleware deprecation warning remains (needs proxy migration).
- `pnpm --filter learning build` (Turbopack) — pass.
- `pnpm run build --filter @enterprise/db --filter @enterprise/auth` — pass (0 errors)
- Dev servers running on:
  - web: http://localhost:3000
  - storefront: http://localhost:3001
  - learning: http://localhost:3002

## Database Migrations Required
Run the following migrations in order:
1. `20251217_order_transaction_function.sql` - Order creation with stock adjustment
2. `20251217_cancel_order_function.sql` - Order cancellation with stock restore
3. `20251217_audit_logs_table.sql` - Audit logging table

## Notes / Next Steps
- Run database migrations on Supabase
- Migrate legacy middleware to the new proxy convention to remove deprecation warning
- If Next bin ENOENT warning recurs, clear root node_modules and reinstall (`rm -rf node_modules && pnpm install`)
