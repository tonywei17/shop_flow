# DEVLOG - 2025-12-06

## 今日の開発トピック

- 社内ストア（Storefront）の基盤構築
- ロール管理にストアフロントアクセス権限を追加
- 認証システム、商品表示、カート、注文機能の実装

---

## 1. データベーススキーマ更新

### 1-1. rolesテーブルへの新カラム追加

```sql
ALTER TABLE roles ADD COLUMN can_access_storefront BOOLEAN DEFAULT false;
ALTER TABLE roles ADD COLUMN default_price_type TEXT DEFAULT 'retail';
```

| カラム | 型 | 説明 |
|--------|------|------|
| `can_access_storefront` | boolean | このロールのユーザーがストアフロントにアクセスできるか |
| `default_price_type` | text | デフォルトで表示される価格タイプ（hq/branch/classroom/retail） |

### 1-2. 新規テーブル

#### ordersテーブル
```sql
CREATE TABLE orders (
  id UUID PRIMARY KEY,
  order_number TEXT UNIQUE NOT NULL,
  user_id UUID NOT NULL REFERENCES admin_accounts(id),
  status TEXT NOT NULL DEFAULT 'pending',
  subtotal INTEGER NOT NULL DEFAULT 0,
  tax_amount INTEGER NOT NULL DEFAULT 0,
  shipping_fee INTEGER NOT NULL DEFAULT 0,
  total_amount INTEGER NOT NULL DEFAULT 0,
  price_type TEXT NOT NULL DEFAULT 'retail',
  shipping_address JSONB,
  payment_status TEXT DEFAULT 'unpaid',
  payment_method TEXT,
  stripe_payment_intent_id TEXT,
  created_at TIMESTAMPTZ DEFAULT now(),
  ...
);
```

#### order_itemsテーブル
```sql
CREATE TABLE order_items (
  id UUID PRIMARY KEY,
  order_id UUID NOT NULL REFERENCES orders(id),
  product_id UUID NOT NULL REFERENCES products(id),
  product_code TEXT NOT NULL,
  product_name TEXT NOT NULL,
  quantity INTEGER NOT NULL DEFAULT 1,
  unit_price INTEGER NOT NULL,
  tax_rate DECIMAL(5,2),
  subtotal INTEGER NOT NULL,
  ...
);
```

#### addressesテーブル
```sql
CREATE TABLE addresses (
  id UUID PRIMARY KEY,
  user_id UUID NOT NULL REFERENCES admin_accounts(id),
  recipient_name TEXT NOT NULL,
  postal_code TEXT,
  prefecture TEXT,
  city TEXT,
  address_line1 TEXT NOT NULL,
  address_line2 TEXT,
  phone TEXT,
  is_default BOOLEAN DEFAULT false,
  ...
);
```

**マイグレーションファイル**: `supabase/migrations/20251206_storefront_schema.sql`

---

## 2. 管理端（apps/web）の更新

### 2-1. ロール管理UIの更新

`apps/web/src/app/(dashboard)/roles/roles-client.tsx` に以下を追加：

- **オンラインストア設定セクション**
  - ストアフロントアクセス権限のトグルスイッチ
  - デフォルト価格タイプのセレクター（本部/支局/教室/一般）

### 2-2. packages/db/src/roles.ts の更新

```typescript
export type PriceType = "hq" | "branch" | "classroom" | "retail";

export type RoleRecord = {
  // ... existing fields
  can_access_storefront?: boolean;
  default_price_type?: PriceType;
};
```

---

## 3. ストアフロント（apps/storefront）の構築

### 3-1. プロジェクト構成

```
apps/storefront/src/
├── app/
│   ├── (auth)/login/
│   │   ├── page.tsx
│   │   └── login-form.tsx
│   ├── products/
│   │   ├── page.tsx
│   │   └── [id]/
│   │       ├── page.tsx
│   │       └── add-to-cart-button.tsx
│   ├── cart/
│   │   ├── page.tsx
│   │   └── cart-content.tsx
│   ├── checkout/
│   │   ├── page.tsx
│   │   ├── checkout-content.tsx
│   │   └── success/page.tsx
│   ├── account/
│   │   ├── page.tsx
│   │   ├── logout-button.tsx
│   │   └── orders/page.tsx
│   ├── api/
│   │   ├── auth/login/route.ts
│   │   ├── auth/logout/route.ts
│   │   └── orders/route.ts
│   ├── layout.tsx
│   ├── page.tsx
│   └── globals.css
├── components/
│   ├── ui/
│   │   ├── button.tsx
│   │   ├── card.tsx
│   │   ├── input.tsx
│   │   ├── label.tsx
│   │   ├── badge.tsx
│   │   ├── avatar.tsx
│   │   └── separator.tsx
│   └── layout/
│       ├── header.tsx
│       └── footer.tsx
├── lib/
│   ├── utils.ts
│   ├── auth/
│   │   ├── types.ts
│   │   └── session.ts
│   └── cart/
│       ├── types.ts
│       └── context.tsx
└── middleware.ts
```

### 3-2. 認証システム

- **セッション管理**: Cookie ベースのセッション（`storefront_session`）
- **ログイン検証**:
  1. アカウントIDでユーザーを検索
  2. アカウントのステータス確認
  3. ロールの `can_access_storefront` を確認
  4. セッション作成

### 3-3. 価格表示ロジック

ユーザーのロールに設定された `default_price_type` に基づいて価格を表示：

```typescript
function getProductPrice(product: any, priceType: PriceType): number {
  switch (priceType) {
    case "hq": return product.price_hq ?? product.price_retail ?? 0;
    case "branch": return product.price_branch ?? product.price_retail ?? 0;
    case "classroom": return product.price_classroom ?? product.price_retail ?? 0;
    default: return product.price_retail ?? 0;
  }
}
```

### 3-4. カート機能

- **CartContext**: React Context + localStorage で状態管理
- **機能**: 追加、削除、数量変更、クリア
- **計算**: 小計、消費税、合計を自動計算

### 3-5. 注文フロー

1. カートに商品を追加
2. カートページで確認
3. チェックアウトページで配送先入力
4. 注文確定 → orders/order_items テーブルに保存
5. 成功ページ表示

---

## 4. 実装済み機能

### 管理端（apps/web）
- [x] ロール編集画面にストアフロントアクセス設定を追加
- [x] デフォルト価格タイプ選択UI

### ストアフロント（apps/storefront）
- [x] モダンなUIデザイン（Tailwind CSS v4）
- [x] ヘッダー・フッターレイアウト
- [x] ログインページ
- [x] 商品一覧ページ（検索・カテゴリフィルター・ページネーション）
- [x] 商品詳細ページ
- [x] カートに追加機能
- [x] カートページ
- [x] チェックアウトページ
- [x] 注文成功ページ
- [x] マイページ
- [x] 注文履歴ページ
- [x] ログアウト機能
- [x] ルート保護（middleware）

---

## 5. 今後のTODO

### 優先度高
1. **Stripe決済統合**: チェックアウト時にStripe Checkoutセッションを作成
2. **パスワード認証**: 現在はデモ用の簡易認証、本番用にbcryptハッシュ化を実装
3. **データベースマイグレーション実行**: `20251206_storefront_schema.sql` を適用

### 優先度中
4. **住所管理ページ**: 配送先住所の追加・編集・削除
5. **注文詳細ページ**: 個別注文の詳細表示
6. **商品画像**: 商品画像のアップロード・表示機能
7. **在庫チェック**: 注文時の在庫確認・減算処理

### 優先度低
8. **メール通知**: 注文確認メール送信
9. **検索機能強化**: 全文検索、ソート機能
10. **レスポンシブ対応の微調整**

---

## 6. 変更ファイル一覧

### 新規作成
- `supabase/migrations/20251206_storefront_schema.sql`
- `apps/storefront/src/lib/utils.ts`
- `apps/storefront/src/lib/auth/types.ts`
- `apps/storefront/src/lib/auth/session.ts`
- `apps/storefront/src/lib/cart/types.ts`
- `apps/storefront/src/lib/cart/context.tsx`
- `apps/storefront/src/components/ui/*.tsx` (button, card, input, label, badge, avatar, separator)
- `apps/storefront/src/components/layout/header.tsx`
- `apps/storefront/src/components/layout/footer.tsx`
- `apps/storefront/src/app/login/page.tsx`
- `apps/storefront/src/app/login/login-form.tsx`
- `apps/storefront/src/app/products/page.tsx`
- `apps/storefront/src/app/products/[id]/add-to-cart-button.tsx`
- `apps/storefront/src/app/cart/page.tsx`
- `apps/storefront/src/app/cart/cart-content.tsx`
- `apps/storefront/src/app/checkout/page.tsx`
- `apps/storefront/src/app/checkout/checkout-content.tsx`
- `apps/storefront/src/app/checkout/success/page.tsx`
- `apps/storefront/src/app/account/page.tsx`
- `apps/storefront/src/app/account/logout-button.tsx`
- `apps/storefront/src/app/account/orders/page.tsx`
- `apps/storefront/src/app/api/auth/login/route.ts`
- `apps/storefront/src/app/api/auth/logout/route.ts`
- `apps/storefront/src/app/api/orders/route.ts`
- `apps/storefront/src/middleware.ts`
- `apps/storefront/postcss.config.mjs`
- `docs/devlogs/DEVLOG-2025-12-06.md`

### 更新
- `packages/db/src/roles.ts` - PriceType追加、storefront関連フィールド追加
- `apps/web/src/app/(dashboard)/roles/roles-client.tsx` - ストアフロント設定UI追加
- `apps/storefront/package.json` - 依存関係追加
- `apps/storefront/tsconfig.json` - パスエイリアス追加
- `apps/storefront/src/app/layout.tsx` - モダンレイアウトに更新
- `apps/storefront/src/app/page.tsx` - ホームページ刷新
- `apps/storefront/src/app/products/[id]/page.tsx` - 商品詳細ページ刷新
- `apps/storefront/src/app/globals.css` - Tailwind v4設定

---

## 7. 起動方法

```bash
# 依存関係インストール
pnpm install

# データベースマイグレーション（Supabase CLIで実行）
supabase db push

# 開発サーバー起動
pnpm dev

# 管理端: http://localhost:3000
# ストアフロント: http://localhost:3001
```

---

## 8. テスト手順

1. 管理端でロールを編集し、「オンラインストアへのアクセス」を有効化
2. デフォルト価格タイプを選択（例：本部価格）
3. そのロールを持つアカウントでストアフロントにログイン
4. 商品一覧で設定した価格タイプの価格が表示されることを確認
5. カートに追加 → チェックアウト → 注文完了のフローを確認
